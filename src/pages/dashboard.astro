---
import { verifyToken } from "../lib/auth.js";

// Verificar autenticaci√≥n
const token = Astro.cookies.get("auth-token")?.value;
const user = token ? verifyToken(token) : null;

if (!user) {
  return Astro.redirect("/login");
}

// Obtener datos del reporte del d√≠a
let reporteData = {
  total_entradas: 0,
  total_cortesias: 0,
  total_efectivo: 0,
  total_transferencia: 0,
  total_terminal1: 0,
  total_terminal2: 0,
  total_ventas: 0,
};

try {
  const baseUrl = Astro.url.origin;
  const response = await fetch(`${baseUrl}/api/reporte-dia`);
  if (response.ok) {
    const result = await response.json();
    if (result.success && result.data) {
      reporteData = result.data;
    }
  }
} catch (error) {
  console.error("Error al obtener reporte:", error);
}

// Calcular m√©tricas
const efectivo = typeof reporteData.total_efectivo === 'string' ? parseFloat(reporteData.total_efectivo) : (reporteData.total_efectivo || 0);
const transferencia = typeof reporteData.total_transferencia === 'string' ? parseFloat(reporteData.total_transferencia) : (reporteData.total_transferencia || 0);
const terminal1 = typeof reporteData.total_terminal1 === 'string' ? parseFloat(reporteData.total_terminal1) : (reporteData.total_terminal1 || 0);
const terminal2 = typeof reporteData.total_terminal2 === 'string' ? parseFloat(reporteData.total_terminal2) : (reporteData.total_terminal2 || 0);
const totalGeneral = efectivo + transferencia + terminal1 + terminal2;
const cuentaFiscal = terminal1 + (efectivo * 0.1);
const totalEntradas = typeof reporteData.total_entradas === 'string' ? parseInt(reporteData.total_entradas) : (reporteData.total_entradas || 0);
const totalCortesias = typeof reporteData.total_cortesias === 'string' ? parseInt(reporteData.total_cortesias) : (reporteData.total_cortesias || 0);
const entradasCobradas = totalEntradas - totalCortesias;

// Calcular porcentajes
const porcentajeEfectivo = totalGeneral > 0 ? (efectivo / totalGeneral * 100) : 0;
const porcentajeTransferencia = totalGeneral > 0 ? (transferencia / totalGeneral * 100) : 0;
const porcentajeTerminal1 = totalGeneral > 0 ? (terminal1 / totalGeneral * 100) : 0;
const porcentajeTerminal2 = totalGeneral > 0 ? (terminal2 / totalGeneral * 100) : 0;
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - La Gruta</title>
    <link rel="stylesheet" href="/src/styles/global.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  </head>
  <body>
    <header class="dashboard-nav">
      <div class="nav-content">
        <div class="user-info">
          <div class="user-avatar">üë§</div>
          <div class="user-details">
            <span class="user-greeting">Hola, <strong>{user.name}</strong></span>
            <span class="current-date">{new Date().toLocaleDateString('es-MX', {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            })}</span>
          </div>
        </div>
        <div class="nav-actions">
          <button class="btn-refresh" onclick="window.location.reload()">
            üîÑ <span class="refresh-text">Actualizar</span>
          </button>
          <form action="/api/logout" method="POST" style="display: inline;">
            <button type="submit" class="btn-logout">
              üö™ <span class="logout-text">Salir</span>
            </button>
          </form>
        </div>
      </div>
    </header>

    <div class="container">
      <!-- Header del reporte -->
      <div class="report-header">
        <div class="report-icon">üìà</div>
        <div class="report-title-section">
          <h1 class="report-title" id="reportTitle">Reporte Completo del D√≠a</h1>
          <p class="report-date" id="reportDate">üìÖ {new Date().toLocaleDateString('es-MX', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
          })}</p>
        </div>
      </div>

      <!-- Selector de Per√≠odo -->
      <div class="period-selector">
        <button class="period-btn active" data-period="diario" id="btnDiario">
          üìÖ Diario
        </button>
        <button class="period-btn" data-period="semanal" id="btnSemanal">
          üìä Semanal
        </button>
        <button class="period-btn" data-period="metricas" id="btnMetricas">
          üìà M√©tricas
        </button>
      </div>

      <!-- Contenedor de Reportes (Diario y Semanal) -->
      <div id="reportesContainer">
      <!-- Resumen General -->
      <div class="report-summary">
        <div class="summary-item">
          <div class="summary-icon">üí∞</div>
          <div class="summary-info">
            <span class="summary-label">Total del D√≠a</span>
            <span class="summary-value">${totalGeneral.toFixed(2)}</span>
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-icon">üé´</div>
          <div class="summary-info">
            <span class="summary-label">Entradas Vendidas</span>
            <span class="summary-value">{entradasCobradas}</span>
          </div>
        </div>
        <div class="summary-item">
          <div class="summary-icon">üìä</div>
          <div class="summary-info">
            <span class="summary-label">Total Ventas</span>
            <span class="summary-value">{reporteData.total_ventas}</span>
          </div>
        </div>
      </div>

      <!-- Desglose por Forma de Pago -->
      <div class="report-card payment-breakdown">
        <div class="card-header">
          <div class="card-icon">üí≥</div>
          <h3>Desglose por Forma de Pago</h3>
        </div>
        <div class="payment-items">
          <div class="payment-item">
            <div class="payment-info">
              <div class="payment-icon">üíµ</div>
              <span class="payment-label">Efectivo</span>
            </div>
            <div class="payment-amount">
              <span class="amount">${efectivo.toFixed(2)}</span>
              <div class="progress-bar">
                <div class="progress-fill efectivo" style={`width: ${porcentajeEfectivo}%`}></div>
              </div>
              <span class="percentage">{porcentajeEfectivo.toFixed(1)}%</span>
            </div>
          </div>
          <div class="payment-item">
            <div class="payment-info">
              <div class="payment-icon">üì±</div>
              <span class="payment-label">Transferencia</span>
            </div>
            <div class="payment-amount">
              <span class="amount">${transferencia.toFixed(2)}</span>
              <div class="progress-bar">
                <div class="progress-fill transferencia" style={`width: ${porcentajeTransferencia}%`}></div>
              </div>
              <span class="percentage">{porcentajeTransferencia.toFixed(1)}%</span>
            </div>
          </div>
          <div class="payment-item">
            <div class="payment-info">
              <div class="payment-icon">üí≥</div>
              <span class="payment-label">Terminal 1</span>
            </div>
            <div class="payment-amount">
              <span class="amount">${terminal1.toFixed(2)}</span>
              <div class="progress-bar">
                <div class="progress-fill terminal1" style={`width: ${porcentajeTerminal1}%`}></div>
              </div>
              <span class="percentage">{porcentajeTerminal1.toFixed(1)}%</span>
            </div>
          </div>
          <div class="payment-item">
            <div class="payment-info">
              <div class="payment-icon">üí≥</div>
              <span class="payment-label">Terminal 2</span>
            </div>
            <div class="payment-amount">
              <span class="amount">${terminal2.toFixed(2)}</span>
              <div class="progress-bar">
                <div class="progress-fill terminal2" style={`width: ${porcentajeTerminal2}%`}></div>
              </div>
              <span class="percentage">{porcentajeTerminal2.toFixed(1)}%</span>
            </div>
          </div>
        </div>
        <div class="payment-total">
          <div class="total-line"></div>
          <div class="total-amount">
            <span class="total-label">Total General</span>
            <span class="total-value">${totalGeneral.toFixed(2)}</span>
          </div>
        </div>
      </div>

      <!-- Cuenta Fiscal y Entradas en Grid -->
      <div class="report-grid">
        <!-- Cuenta Fiscal -->
        <div class="report-card fiscal-card">
          <div class="card-header">
            <div class="card-icon">üèõÔ∏è</div>
            <h3>Cuenta Fiscal</h3>
          </div>
          <div class="fiscal-items">
            <div class="fiscal-item">
              <div class="fiscal-item-info">
                <span class="fiscal-label">üí≥ Terminal 1</span>
                <span class="fiscal-amount">${terminal1.toFixed(2)}</span>
              </div>
            </div>
            <div class="fiscal-item">
              <div class="fiscal-item-info">
                <span class="fiscal-label">üíµ Efectivo (Variable Declarado de Manera Manual)</span>
                <!-- <span class="fiscal-amount">${(efectivo * 0.1).toFixed(2)}</span> -->
              </div>
            </div>
          </div>
          <div class="fiscal-total">
            <div class="total-line"></div>
            <div class="total-amount">
              <span class="total-label">Total Fiscal</span>
              <span class="total-value">${cuentaFiscal.toFixed(2)}</span>
            </div>
          </div>
        </div>

        <!-- Estad√≠sticas de Entradas -->
        <div class="report-card entries-card">
          <div class="card-header">
            <div class="card-icon">üé´</div>
            <h3>Estad√≠sticas de Entradas</h3>
          </div>
          <div class="entries-stats">
            <div class="stat-item">
              <div class="stat-icon-small">üéüÔ∏è</div>
              <div class="stat-info-small">
                <span class="stat-label-small">Total Entradas</span>
                <span class="stat-value-small">{totalEntradas}</span>
              </div>
            </div>
            <div class="stat-item">
              <div class="stat-icon-small">üéÅ</div>
              <div class="stat-info-small">
                <span class="stat-label-small">Cortes√≠as</span>
                <span class="stat-value-small">{totalCortesias}</span>
              </div>
            </div>
            <div class="stat-item highlight">
              <div class="stat-icon-small">üí∞</div>
              <div class="stat-info-small">
                <span class="stat-label-small">Entradas Cobradas</span>
                <span class="stat-value-small">{entradasCobradas}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>

      <!-- Contenedor de M√©tricas Mensuales -->
      <div id="metricasContainer" style="display: none;">
        <!-- Tarjeta de Gr√°fica de Ventas Diarias -->
        <div class="report-card metrics-card">
          <div class="card-header">
            <div class="card-icon">üìä</div>
            <h3 id="metricasTitulo">Ventas Diarias del Mes</h3>
          </div>
          <div class="chart-container">
            <canvas id="chartVentasDiarias"></canvas>
          </div>
        </div>

        <!-- Tarjeta de Gr√°fica de Ventas por Semana -->
        <div class="report-card metrics-card-semanas">
          <div class="card-header">
            <div class="card-icon">üìÖ</div>
            <h3>Desglose por Semanas del Mes</h3>
          </div>
          <div class="chart-container">
            <canvas id="chartVentasSemanales"></canvas>
          </div>
        </div>

        <!-- Tarjetas de Resumen por Semana -->
        <div class="report-card">
          <div class="card-header">
            <div class="card-icon">üóìÔ∏è</div>
            <h3>Resumen por Semana</h3>
          </div>
          <div id="resumenSemanas" class="semanas-grid">
            <!-- Se llenar√° din√°micamente con JavaScript -->
          </div>
        </div>

        <!-- An√°lisis de Horarios Pico -->
        <div class="report-card metrics-card-horarios">
          <div class="card-header">
            <div class="card-icon">‚è∞</div>
            <h3>An√°lisis de Horarios - Identifica tus Horas Pico</h3>
          </div>
          <div class="chart-container">
            <canvas id="chartHorarios"></canvas>
          </div>
        </div>

        <!-- Insights de Negocio -->
        <div class="insights-grid">
          <!-- Horario Pico -->
          <div class="insight-card insight-primary">
            <div class="insight-icon">üïê</div>
            <div class="insight-content">
              <span class="insight-label">Horario Pico (Ventas)</span>
              <span class="insight-value" id="horaPicoVentas">--:--</span>
              <span class="insight-sublabel" id="ventasEnPico">-- transacciones</span>
            </div>
          </div>

          <!-- Ticket Promedio -->
          <div class="insight-card insight-success">
            <div class="insight-icon">üí≥</div>
            <div class="insight-content">
              <span class="insight-label">Ticket Promedio</span>
              <span class="insight-value" id="ticketPromedio">$0.00</span>
              <span class="insight-sublabel" id="entradasPromedio">-- entradas/venta</span>
            </div>
          </div>

          <!-- Mejor Hora (Ingresos) -->
          <div class="insight-card insight-warning">
            <div class="insight-icon">üí∞</div>
            <div class="insight-content">
              <span class="insight-label">Mayor Ingreso por Hora</span>
              <span class="insight-value" id="horaPicoIngresos">--:--</span>
              <span class="insight-sublabel" id="ingresosEnPico">$0.00</span>
            </div>
          </div>

          <!-- Horario de Operaci√≥n -->
          <div class="insight-card insight-info">
            <div class="insight-icon">üïí</div>
            <div class="insight-content">
              <span class="insight-label">Horario de Operaci√≥n</span>
              <span class="insight-value" id="horarioOperacion">--:-- a --:--</span>
              <span class="insight-sublabel">Basado en ventas reales</span>
            </div>
          </div>
        </div>

        <!-- Distribuci√≥n por Periodo del D√≠a -->
        <div class="report-card">
          <div class="card-header">
            <div class="card-icon">üåÖ</div>
            <h3>Distribuci√≥n por Periodo del D√≠a</h3>
          </div>
          <div id="periodosContainer" class="periodos-grid">
            <!-- Se llenar√° din√°micamente -->
          </div>
        </div>

        <!-- Resumen Mensual -->
        <div class="report-card">
          <div class="card-header">
            <div class="card-icon">üí∞</div>
            <h3>Resumen del Mes</h3>
          </div>
          <div class="payment-items">
            <div class="payment-item">
              <div class="payment-info">
                <div class="payment-icon">üíµ</div>
                <span class="payment-label">Total Vendido</span>
              </div>
              <div class="payment-amount">
                <span class="amount" id="totalMensual">$0.00</span>
              </div>
            </div>
            <div class="payment-item">
              <div class="payment-info">
                <div class="payment-icon">üé´</div>
                <span class="payment-label">Total Entradas</span>
              </div>
              <div class="payment-amount">
                <span class="amount" id="entradasMensual">0</span>
              </div>
            </div>
            <div class="payment-item">
              <div class="payment-info">
                <div class="payment-icon">üìà</div>
                <span class="payment-label">Total Ventas</span>
              </div>
              <div class="payment-amount">
                <span class="amount" id="ventasMensual">0</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #f0f4f8 0%, #e2e8f0 100%);
        color: #2d3748;
        min-height: 100vh;
        overflow-x: hidden;
      }

      /* Navigation Header */
      .dashboard-nav {
        background: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
        border-bottom: 1px solid #e2e8f0;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .nav-content {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1rem 1.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 1rem;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
      }

      .user-details {
        display: flex;
        flex-direction: column;
        gap: 0.125rem;
      }

      .user-greeting {
        font-size: 0.875rem;
        color: #2d3748;
        font-weight: 500;
      }

      .user-greeting strong {
        font-weight: 700;
        color: #1a202c;
      }

      .current-date {
        font-size: 0.75rem;
        color: #718096;
        text-transform: capitalize;
      }

      .nav-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .btn-refresh, .btn-logout {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        white-space: nowrap;
      }

      .btn-refresh {
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        color: white;
      }

      .btn-refresh:hover {
        background: linear-gradient(135deg, #3182ce 0%, #2c5282 100%);
        transform: translateY(-1px);
      }

      .btn-logout {
        background: #ffffff;
        color: #e53e3e;
        border: 1px solid #e2e8f0;
      }

      .btn-logout:hover {
        background: #fff5f5;
        border-color: #fc8181;
      }

      /* Container */
      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 1.5rem;
      }

      /* Report Header */
      .report-header {
        background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
        border-radius: 16px;
        border-left: 5px solid #4299e1;
        padding: 1.5rem;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      /* Period Selector */
      .period-selector {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        padding: 0.5rem;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        width: fit-content;
      }

      .period-btn {
        padding: 0.75rem 1.5rem;
        border: 2px solid #e2e8f0;
        border-radius: 8px;
        background: #ffffff;
        color: #4a5568;
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .period-btn:hover {
        border-color: #4299e1;
        background: #f7fafc;
      }

      .period-btn.active {
        background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
        color: white;
        border-color: #4299e1;
      }

      .report-icon {
        font-size: 2.5rem;
        animation: pulse-icon 2s infinite;
      }

      @keyframes pulse-icon {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
      }

      .report-title-section {
        flex: 1;
      }

      .report-title {
        margin: 0;
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a202c;
      }

      .report-date {
        margin: 0.25rem 0 0 0;
        color: #4a5568;
        font-weight: 500;
        font-size: 0.875rem;
        text-transform: capitalize;
      }

      /* Report Summary - Cards principales */
      .report-summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .summary-item {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
        cursor: pointer;
      }

      .summary-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
      }

      .summary-item:nth-child(1) {
        border-left: 4px solid #48bb78;
      }

      .summary-item:nth-child(2) {
        border-left: 4px solid #4299e1;
      }

      .summary-item:nth-child(3) {
        border-left: 4px solid #ed8936;
      }

      .summary-icon {
        font-size: 2.5rem;
        flex-shrink: 0;
      }

      .summary-info {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .summary-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
      }

      .summary-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #1a202c;
      }

      /* Report Cards */
      .report-card {
        background: #ffffff;
        border: 1px solid #e2e8f0;
        border-radius: 16px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      }

      .card-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1.25rem;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
      }

      .card-icon {
        font-size: 1.5rem;
      }

      .card-header h3 {
        margin: 0;
        font-size: 1.125rem;
        font-weight: 600;
        color: #1a202c;
      }

      /* Payment Breakdown */
      .payment-breakdown {
        border-left: 5px solid #ed8936;
      }

      .payment-items {
        padding: 1.25rem;
      }

      .payment-item {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
        padding: 1rem 0;
        border-bottom: 1px solid #f1f5f9;
      }

      .payment-item:last-child {
        border-bottom: none;
      }

      .payment-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }

      .payment-icon {
        font-size: 1.5rem;
      }

      .payment-label {
        font-weight: 600;
        color: #2d3748;
        font-size: 1rem;
      }

      .payment-amount {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding-left: 2.25rem;
      }

      .payment-amount .amount {
        font-weight: 700;
        color: #1a202c;
        font-size: 1.25rem;
        min-width: 110px;
      }

      .progress-bar {
        flex: 1;
        height: 12px;
        background: #e2e8f0;
        border-radius: 6px;
        overflow: hidden;
        min-width: 100px;
      }

      .progress-fill {
        height: 100%;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .progress-fill.efectivo {
        background: linear-gradient(90deg, #48bb78 0%, #68d391 100%);
      }

      .progress-fill.transferencia {
        background: linear-gradient(90deg, #4299e1 0%, #63b3ed 100%);
      }

      .progress-fill.terminal1 {
        background: linear-gradient(90deg, #ed8936 0%, #f6ad55 100%);
      }

      .progress-fill.terminal2 {
        background: linear-gradient(90deg, #9f7aea 0%, #b794f6 100%);
      }

      .percentage {
        font-size: 0.875rem;
        font-weight: 600;
        color: #6b7280;
        min-width: 50px;
        text-align: right;
      }

      .payment-total {
        padding: 1.25rem;
        border-top: 2px solid #e2e8f0;
        background: #f8fafc;
      }

      .total-amount {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .total-label {
        font-weight: 600;
        color: #2d3748;
        font-size: 1.125rem;
      }

      .total-value {
        font-weight: 700;
        color: #1a202c;
        font-size: 1.75rem;
      }

      /* Report Grid (Fiscal + Entries) */
      .report-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
      }

      /* Fiscal Card */
      .fiscal-card {
        border-left: 5px solid #4299e1;
      }

      .fiscal-items {
        padding: 1.25rem;
      }

      .fiscal-item {
        padding: 0.875rem 0;
        border-bottom: 1px solid #f1f5f9;
      }

      .fiscal-item:last-child {
        border-bottom: none;
      }

      .fiscal-item-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .fiscal-label {
        font-weight: 500;
        color: #4a5568;
        font-size: 0.9375rem;
      }

      .fiscal-amount {
        font-weight: 700;
        color: #1a202c;
        font-size: 1.125rem;
      }

      .fiscal-total {
        padding: 1.25rem;
        background: #f8fafc;
        border-top: 2px solid #e2e8f0;
      }

      .total-line {
        height: 2px;
        background: linear-gradient(90deg, #4299e1 0%, #63b3ed 100%);
        margin-bottom: 1rem;
      }

      /* Entries Card */
      .entries-card {
        border-left: 5px solid #48bb78;
      }

      .entries-stats {
        padding: 1.25rem;
      }

      .stat-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        margin-bottom: 0.75rem;
        background: #f8fafc;
        border-radius: 10px;
        transition: all 0.2s ease;
      }

      .stat-item:last-child {
        margin-bottom: 0;
      }

      .stat-item:hover {
        background: #edf2f7;
        transform: translateX(4px);
      }

      .stat-item.highlight {
        background: linear-gradient(135deg, #f0fff4 0%, #e6fffa 100%);
        border: 1px solid #68d391;
      }

      .stat-icon-small {
        font-size: 1.75rem;
        flex-shrink: 0;
      }

      .stat-info-small {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .stat-label-small {
        font-size: 0.875rem;
        font-weight: 500;
        color: #6b7280;
      }

      .stat-value-small {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a202c;
      }

      /* M√©tricas Card */
      .metrics-card {
        border-left: 5px solid #9f7aea;
      }

      .metrics-card-semanas {
        border-left: 5px solid #48bb78;
      }

      .metrics-card-horarios {
        border-left: 5px solid #ed8936;
      }

      .chart-container {
        padding: 2rem 1.5rem;
        background: #ffffff;
        min-height: 400px;
        position: relative;
      }

      #chartVentasDiarias {
        max-height: 400px;
      }

      #chartVentasSemanales {
        max-height: 350px;
      }

      #metricasContainer {
        animation: fadeIn 0.3s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Grid de Semanas */
      .semanas-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 1.25rem;
        padding: 1.5rem;
      }

      .semana-card {
        background: #ffffff;
        border: 2px solid transparent;
        border-radius: 16px;
        padding: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        overflow: hidden;
        position: relative;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .semana-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, var(--semana-color-light) 0%, var(--semana-color) 100%);
      }

      .semana-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        border-color: var(--semana-color);
      }

      .semana-card.semana-1 {
        --semana-color: #48bb78;
        --semana-color-light: #68d391;
        --semana-color-bg: #f0fff4;
      }

      .semana-card.semana-2 {
        --semana-color: #4299e1;
        --semana-color-light: #63b3ed;
        --semana-color-bg: #ebf8ff;
      }

      .semana-card.semana-3 {
        --semana-color: #ed8936;
        --semana-color-light: #f6ad55;
        --semana-color-bg: #fffaf0;
      }

      .semana-card.semana-4 {
        --semana-color: #9f7aea;
        --semana-color-light: #b794f6;
        --semana-color-bg: #faf5ff;
      }

      .semana-card.semana-5 {
        --semana-color: #f56565;
        --semana-color-light: #fc8181;
        --semana-color-bg: #fff5f5;
      }

      .semana-card.semana-6 {
        --semana-color: #38b2ac;
        --semana-color-light: #4fd1c5;
        --semana-color-bg: #e6fffa;
      }

      .semana-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1.25rem 1.25rem 1rem 1.25rem;
        background: var(--semana-color-bg);
      }

      .semana-numero-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .semana-numero {
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        font-weight: 700;
        color: white;
        background: linear-gradient(135deg, var(--semana-color) 0%, var(--semana-color-light) 100%);
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      .semana-rango {
        font-size: 0.8125rem;
        color: #4a5568;
        font-weight: 600;
        background: white;
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        border: 1px solid #e2e8f0;
      }

      .semana-stats {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        padding: 1.25rem;
      }

      .semana-stat {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .semana-stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .semana-stat-label {
        font-size: 0.8125rem;
        color: #6b7280;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.375rem;
      }

      .semana-stat-icon {
        font-size: 1rem;
      }

      .semana-stat-value {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--semana-color);
      }

      .semana-stat-value.highlight {
        font-size: 1.5rem;
      }

      .semana-progress-bar {
        height: 8px;
        background: #e2e8f0;
        border-radius: 10px;
        overflow: hidden;
        position: relative;
      }

      .semana-progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--semana-color) 0%, var(--semana-color-light) 100%);
        border-radius: 10px;
        transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .semana-divider {
        height: 1px;
        background: linear-gradient(90deg, transparent 0%, #e2e8f0 50%, transparent 100%);
        margin: 0.5rem 0;
      }

      /* Insights Grid */
      .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.25rem;
        margin-bottom: 1.5rem;
      }

      .insight-card {
        background: #ffffff;
        border-radius: 16px;
        padding: 1.5rem;
        display: flex;
        align-items: flex-start;
        gap: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
      }

      .insight-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: var(--insight-color);
      }

      .insight-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        border-color: var(--insight-color);
      }

      .insight-card.insight-primary {
        --insight-color: #4299e1;
        --insight-bg: #ebf8ff;
      }

      .insight-card.insight-success {
        --insight-color: #48bb78;
        --insight-bg: #f0fff4;
      }

      .insight-card.insight-warning {
        --insight-color: #ed8936;
        --insight-bg: #fffaf0;
      }

      .insight-card.insight-info {
        --insight-color: #9f7aea;
        --insight-bg: #faf5ff;
      }

      .insight-icon {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        background: var(--insight-bg);
        border-radius: 12px;
        flex-shrink: 0;
      }

      .insight-content {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        flex: 1;
      }

      .insight-label {
        font-size: 0.75rem;
        font-weight: 600;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .insight-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--insight-color);
        line-height: 1.2;
      }

      .insight-sublabel {
        font-size: 0.875rem;
        color: #9ca3af;
        font-weight: 500;
      }

      /* Periodos Grid */
      .periodos-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        padding: 1.25rem;
      }

      .periodo-card {
        background: linear-gradient(135deg, var(--periodo-bg-light) 0%, var(--periodo-bg) 100%);
        border: 2px solid var(--periodo-border);
        border-radius: 12px;
        padding: 1.25rem;
        transition: all 0.3s ease;
      }

      .periodo-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        border-color: var(--periodo-color);
      }

      .periodo-card.periodo-ma√±ana {
        --periodo-color: #f59e0b;
        --periodo-bg: #fffbeb;
        --periodo-bg-light: #fef3c7;
        --periodo-border: #fde68a;
      }

      .periodo-card.periodo-tarde {
        --periodo-color: #3b82f6;
        --periodo-bg: #eff6ff;
        --periodo-bg-light: #dbeafe;
        --periodo-border: #bfdbfe;
      }

      .periodo-card.periodo-noche {
        --periodo-color: #8b5cf6;
        --periodo-bg: #f5f3ff;
        --periodo-bg-light: #ede9fe;
        --periodo-border: #ddd6fe;
      }

      .periodo-card.periodo-madrugada {
        --periodo-color: #6366f1;
        --periodo-bg: #eef2ff;
        --periodo-bg-light: #e0e7ff;
        --periodo-border: #c7d2fe;
      }

      .periodo-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
      }

      .periodo-icon {
        font-size: 2rem;
      }

      .periodo-nombre {
        font-size: 1.125rem;
        font-weight: 700;
        color: var(--periodo-color);
      }

      .periodo-horario {
        font-size: 0.75rem;
        color: #6b7280;
        font-weight: 600;
      }

      .periodo-stats {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .periodo-stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .periodo-stat-label {
        font-size: 0.875rem;
        color: #6b7280;
        font-weight: 500;
      }

      .periodo-stat-value {
        font-size: 1rem;
        font-weight: 700;
        color: var(--periodo-color);
      }

      #chartHorarios {
        max-height: 400px;
      }

      /* Mobile Responsive */
      @media (max-width: 768px) {
        .nav-content {
          padding: 0.75rem 1rem;
        }

        .user-avatar {
          width: 36px;
          height: 36px;
          font-size: 1rem;
        }

        .refresh-text, .logout-text {
          display: none;
        }

        .btn-refresh, .btn-logout {
          padding: 0.5rem;
          min-width: 40px;
          justify-content: center;
        }

        .container {
          padding: 1rem;
        }

        .period-selector {
          width: 100%;
          justify-content: center;
          flex-wrap: nowrap;
        }

        .period-btn {
          flex: 1;
          padding: 0.625rem 0.875rem;
          font-size: 0.875rem;
        }

        .report-header {
          padding: 1rem;
        }

        .report-icon {
          font-size: 2rem;
        }

        .report-title {
          font-size: 1.25rem;
        }

        .report-date {
          font-size: 0.75rem;
        }

        .report-summary {
          grid-template-columns: 1fr;
        }

        .summary-item {
          padding: 1.25rem;
        }

        .summary-value {
          font-size: 1.5rem;
        }

        .report-grid {
          grid-template-columns: 1fr;
        }

        .payment-amount {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.75rem;
          padding-left: 2.25rem;
        }

        .progress-bar {
          width: 100%;
          min-width: 100%;
        }

        .payment-amount .amount {
          min-width: auto;
        }

        .percentage {
          align-self: flex-end;
        }

        /* Estilos para M√©tricas en tablets */
        .chart-container {
          padding: 1.5rem 1rem;
          min-height: 350px;
        }

        #chartVentasDiarias {
          max-height: 350px;
        }

        #chartVentasSemanales {
          max-height: 300px;
        }

        #chartHorarios {
          max-height: 350px;
        }

        .semanas-grid {
          grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
          padding: 1.25rem;
          gap: 1rem;
        }

        .insights-grid {
          grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
          gap: 1rem;
        }

        .insight-icon {
          width: 50px;
          height: 50px;
          font-size: 1.75rem;
        }

        .insight-value {
          font-size: 1.5rem;
        }

        .periodos-grid {
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        }

        .semana-header {
          padding: 1rem 1rem 0.875rem 1rem;
        }

        .semana-numero {
          width: 45px;
          height: 45px;
          font-size: 1.125rem;
        }

        .semana-stats {
          padding: 1rem;
          gap: 0.875rem;
        }
      }

      /* Small mobile devices */
      @media (max-width: 480px) {
        .user-greeting {
          font-size: 0.75rem;
        }

        .current-date {
          font-size: 0.6875rem;
        }

        .summary-item {
          padding: 1rem;
        }

        .summary-icon {
          font-size: 2rem;
        }

        .summary-value {
          font-size: 1.375rem;
        }

        .payment-amount {
          padding-left: 0;
        }

        .card-header {
          padding: 1rem;
        }

        .payment-items {
          padding: 1rem;
        }

        .fiscal-items, .entries-stats {
          padding: 1rem;
        }

        /* Estilos para M√©tricas en m√≥viles peque√±os */
        .chart-container {
          padding: 1rem 0.75rem;
          min-height: 300px;
        }

        #chartVentasDiarias {
          max-height: 300px;
        }

        .period-selector {
          gap: 0.5rem;
          padding: 0.375rem;
        }

        .period-btn {
          padding: 0.625rem 0.5rem;
          font-size: 0.75rem;
          gap: 0.25rem;
          white-space: nowrap;
        }

        .card-header h3 {
          font-size: 0.9375rem;
        }

        #metricasTitulo {
          font-size: 0.875rem;
        }

        #chartVentasSemanales {
          max-height: 280px;
        }

        #chartHorarios {
          max-height: 300px;
        }

        .semanas-grid {
          grid-template-columns: 1fr;
          padding: 1rem;
          gap: 1rem;
        }

        .insights-grid {
          grid-template-columns: 1fr;
          gap: 0.875rem;
        }

        .insight-card {
          padding: 1.125rem;
        }

        .insight-icon {
          width: 45px;
          height: 45px;
          font-size: 1.5rem;
        }

        .insight-label {
          font-size: 0.6875rem;
        }

        .insight-value {
          font-size: 1.375rem;
        }

        .insight-sublabel {
          font-size: 0.8125rem;
        }

        .periodos-grid {
          grid-template-columns: 1fr;
          gap: 0.875rem;
          padding: 1rem;
        }

        .semana-header {
          padding: 0.875rem 0.875rem 0.75rem 0.875rem;
          flex-direction: column;
          align-items: flex-start;
          gap: 0.625rem;
        }

        .semana-numero {
          width: 40px;
          height: 40px;
          font-size: 1rem;
        }

        .semana-rango {
          font-size: 0.75rem;
          padding: 0.25rem 0.625rem;
        }

        .semana-stats {
          padding: 0.875rem;
          gap: 0.75rem;
        }

        .semana-stat-label {
          font-size: 0.75rem;
        }

        .semana-stat-icon {
          font-size: 0.875rem;
        }

        .semana-stat-value {
          font-size: 1rem;
        }

        .semana-stat-value.highlight {
          font-size: 1.25rem;
        }

        .semana-progress-bar {
          height: 6px;
        }
      }

      /* Extra small devices */
      @media (max-width: 360px) {
        .period-btn {
          padding: 0.5rem 0.375rem;
          font-size: 0.6875rem;
        }

        #metricasTitulo {
          font-size: 0.8125rem;
        }

        .semana-header {
          padding: 0.75rem 0.75rem 0.625rem 0.75rem;
        }

        .semana-numero {
          width: 36px;
          height: 36px;
          font-size: 0.9375rem;
        }

        .semana-rango {
          font-size: 0.6875rem;
        }

        .semana-stats {
          padding: 0.75rem;
          gap: 0.625rem;
        }

        .semana-stat-label {
          font-size: 0.6875rem;
        }

        .semana-stat-icon {
          font-size: 0.75rem;
        }

        .semana-stat-value {
          font-size: 0.9375rem;
        }

        .semana-stat-value.highlight {
          font-size: 1.125rem;
        }

        .semana-progress-bar {
          height: 5px;
        }

        .insight-icon {
          width: 40px;
          height: 40px;
          font-size: 1.375rem;
        }

        .insight-value {
          font-size: 1.25rem;
        }
      }
    </style>

    <script is:inline>
      // Funci√≥n para formatear n√∫meros como moneda
      function formatMoney(value) {
        return `$${parseFloat(String(value)).toFixed(2)}`;
      }

      // Funci√≥n para cargar datos seg√∫n el per√≠odo
      async function cargarDatos(periodo) {
        const endpoint = periodo === 'diario' ? '/api/reporte-dia' : '/api/reporte-semanal';

        try {
          const response = await fetch(endpoint);
          const result = await response.json();

          if (result.success && result.data) {
            actualizarDashboard(result.data, periodo);
          }
        } catch (error) {
          console.error('Error al cargar datos:', error);
        }
      }

      // Funci√≥n para actualizar el dashboard con nuevos datos
      function actualizarDashboard(data, periodo) {
        const efectivo = typeof data.total_efectivo === 'string' ? parseFloat(data.total_efectivo) : (data.total_efectivo || 0);
        const transferencia = typeof data.total_transferencia === 'string' ? parseFloat(data.total_transferencia) : (data.total_transferencia || 0);
        const terminal1 = typeof data.total_terminal1 === 'string' ? parseFloat(data.total_terminal1) : (data.total_terminal1 || 0);
        const terminal2 = typeof data.total_terminal2 === 'string' ? parseFloat(data.total_terminal2) : (data.total_terminal2 || 0);
        const totalGeneral = efectivo + transferencia + terminal1 + terminal2;
        const cuentaFiscal = terminal1 + (efectivo * 0.1);
        const totalEntradas = typeof data.total_entradas === 'string' ? parseInt(data.total_entradas) : (data.total_entradas || 0);
        const totalCortesias = typeof data.total_cortesias === 'string' ? parseInt(data.total_cortesias) : (data.total_cortesias || 0);
        const entradasCobradas = totalEntradas - totalCortesias;

        // Calcular porcentajes
        const porcentajeEfectivo = totalGeneral > 0 ? (efectivo / totalGeneral * 100) : 0;
        const porcentajeTransferencia = totalGeneral > 0 ? (transferencia / totalGeneral * 100) : 0;
        const porcentajeTerminal1 = totalGeneral > 0 ? (terminal1 / totalGeneral * 100) : 0;
        const porcentajeTerminal2 = totalGeneral > 0 ? (terminal2 / totalGeneral * 100) : 0;

        // Actualizar t√≠tulo
        const titulo = periodo === 'diario' ? 'Reporte Completo del D√≠a' : 'Reporte Semanal';
        const reportTitle = document.getElementById('reportTitle');
        if (reportTitle) reportTitle.textContent = titulo;

        // Actualizar fecha
        if (periodo === 'semanal' && data.fechaInicio && data.fechaFin) {
          const reportDate = document.getElementById('reportDate');
          if (reportDate) reportDate.textContent = `üìÖ ${data.fechaInicio} al ${data.fechaFin}`;
        }

        // Actualizar cards de resumen
        const summaryValue1 = document.querySelector('.summary-item:nth-child(1) .summary-value');
        if (summaryValue1) summaryValue1.textContent = formatMoney(totalGeneral);

        const summaryValue2 = document.querySelector('.summary-item:nth-child(2) .summary-value');
        if (summaryValue2) summaryValue2.textContent = String(entradasCobradas);

        const summaryValue3 = document.querySelector('.summary-item:nth-child(3) .summary-value');
        if (summaryValue3) summaryValue3.textContent = String(data.total_ventas || 0);

        // Actualizar desglose de pagos
        const paymentItems = document.querySelectorAll('.payment-item');

        // Efectivo
        const amount0 = paymentItems[0]?.querySelector('.amount');
        const progressFill0 = paymentItems[0]?.querySelector('.progress-fill');
        const percentage0 = paymentItems[0]?.querySelector('.percentage');
        if (amount0) amount0.textContent = formatMoney(efectivo);
        if (progressFill0 instanceof HTMLElement) progressFill0.style.width = `${porcentajeEfectivo}%`;
        if (percentage0) percentage0.textContent = `${porcentajeEfectivo.toFixed(1)}%`;

        // Transferencia
        const amount1 = paymentItems[1]?.querySelector('.amount');
        const progressFill1 = paymentItems[1]?.querySelector('.progress-fill');
        const percentage1 = paymentItems[1]?.querySelector('.percentage');
        if (amount1) amount1.textContent = formatMoney(transferencia);
        if (progressFill1 instanceof HTMLElement) progressFill1.style.width = `${porcentajeTransferencia}%`;
        if (percentage1) percentage1.textContent = `${porcentajeTransferencia.toFixed(1)}%`;

        // Terminal 1
        const amount2 = paymentItems[2]?.querySelector('.amount');
        const progressFill2 = paymentItems[2]?.querySelector('.progress-fill');
        const percentage2 = paymentItems[2]?.querySelector('.percentage');
        if (amount2) amount2.textContent = formatMoney(terminal1);
        if (progressFill2 instanceof HTMLElement) progressFill2.style.width = `${porcentajeTerminal1}%`;
        if (percentage2) percentage2.textContent = `${porcentajeTerminal1.toFixed(1)}%`;

        // Terminal 2
        const amount3 = paymentItems[3]?.querySelector('.amount');
        const progressFill3 = paymentItems[3]?.querySelector('.progress-fill');
        const percentage3 = paymentItems[3]?.querySelector('.percentage');
        if (amount3) amount3.textContent = formatMoney(terminal2);
        if (progressFill3 instanceof HTMLElement) progressFill3.style.width = `${porcentajeTerminal2}%`;
        if (percentage3) percentage3.textContent = `${porcentajeTerminal2.toFixed(1)}%`;

        // Total General
        const totalValue = document.querySelector('.payment-total .total-value');
        if (totalValue) totalValue.textContent = formatMoney(totalGeneral);

        // Cuenta Fiscal
        const fiscalItems = document.querySelectorAll('.fiscal-item');
        const fiscalAmount0 = fiscalItems[0]?.querySelector('.fiscal-amount');
        const fiscalAmount1 = fiscalItems[1]?.querySelector('.fiscal-amount');
        if (fiscalAmount0) fiscalAmount0.textContent = formatMoney(terminal1);
        if (fiscalAmount1) fiscalAmount1.textContent = formatMoney(efectivo * 0.1);

        const fiscalTotalValue = document.querySelector('.fiscal-total .total-value');
        if (fiscalTotalValue) fiscalTotalValue.textContent = formatMoney(cuentaFiscal);

        // Estad√≠sticas de Entradas
        const statItems = document.querySelectorAll('.stat-item');
        const statValue0 = statItems[0]?.querySelector('.stat-value-small');
        const statValue1 = statItems[1]?.querySelector('.stat-value-small');
        const statValue2 = statItems[2]?.querySelector('.stat-value-small');
        if (statValue0) statValue0.textContent = String(totalEntradas);
        if (statValue1) statValue1.textContent = String(totalCortesias);
        if (statValue2) statValue2.textContent = String(entradasCobradas);
      }

      // Event listeners para los botones
      const btnDiario = document.getElementById('btnDiario');
      const btnSemanal = document.getElementById('btnSemanal');
      const btnMetricas = document.getElementById('btnMetricas');
      const reportesContainer = document.getElementById('reportesContainer');
      const metricasContainer = document.getElementById('metricasContainer');

      // Variable para almacenar las instancias de las gr√°ficas
      let chartInstance = null;
      let chartSemanalInstance = null;
      let chartHorariosInstance = null;

      // Funci√≥n para mostrar reportes y ocultar m√©tricas
      function mostrarReportes() {
        if (reportesContainer) reportesContainer.style.display = 'block';
        if (metricasContainer) metricasContainer.style.display = 'none';
      }

      // Funci√≥n para mostrar m√©tricas y ocultar reportes
      function mostrarMetricas() {
        if (reportesContainer) reportesContainer.style.display = 'none';
        if (metricasContainer) metricasContainer.style.display = 'block';
      }

      // Funci√≥n para cargar an√°lisis de horarios
      async function cargarAnalisisHorarios() {
        try {
          const response = await fetch('/api/analisis-horarios');
          const result = await response.json();

          if (result.success && result.data) {
            const data = result.data;

            // Actualizar tarjetas de insights
            const horaPicoVentasEl = document.getElementById('horaPicoVentas');
            const ventasEnPicoEl = document.getElementById('ventasEnPico');
            const ticketPromedioEl = document.getElementById('ticketPromedio');
            const entradasPromedioEl = document.getElementById('entradasPromedio');
            const horaPicoIngresosEl = document.getElementById('horaPicoIngresos');
            const ingresosEnPicoEl = document.getElementById('ingresosEnPico');
            const horarioOperacionEl = document.getElementById('horarioOperacion');

            if (horaPicoVentasEl) {
              horaPicoVentasEl.textContent = `${data.horaPicoVentas.toString().padStart(2, '0')}:00`;
            }

            const ventasEnHoraPico = data.ventasPorHora.find(h => h.hora === data.horaPicoVentas);
            if (ventasEnPicoEl && ventasEnHoraPico) {
              ventasEnPicoEl.textContent = `${ventasEnHoraPico.ventas} transacciones`;
            }

            if (ticketPromedioEl) {
              ticketPromedioEl.textContent = formatMoney(data.ticketPromedio);
            }

            if (entradasPromedioEl) {
              entradasPromedioEl.textContent = `${data.entradasPromedio.toFixed(1)} entradas/venta`;
            }

            if (horaPicoIngresosEl) {
              horaPicoIngresosEl.textContent = `${data.horaPicoIngresos.toString().padStart(2, '0')}:00`;
            }

            const ingresosEnHoraPico = data.ventasPorHora.find(h => h.hora === data.horaPicoIngresos);
            if (ingresosEnPicoEl && ingresosEnHoraPico) {
              ingresosEnPicoEl.textContent = formatMoney(ingresosEnHoraPico.total);
            }

            if (horarioOperacionEl) {
              horarioOperacionEl.textContent = `${data.horaApertura.toString().padStart(2, '0')}:00 a ${data.horaCierre.toString().padStart(2, '0')}:00`;
            }

            // Crear gr√°fica de horarios
            const labelsHorarios = data.ventasPorHora.map(h => h.horaFormato);
            const ventasHorarios = data.ventasPorHora.map(h => h.total);

            const ctxHorarios = document.getElementById('chartHorarios');
            if (ctxHorarios) {
              const isMobile = window.innerWidth <= 768;
              const isSmallMobile = window.innerWidth <= 480;

              chartHorariosInstance = new Chart(ctxHorarios, {
                type: 'line',
                data: {
                  labels: labelsHorarios,
                  datasets: [{
                    label: 'Ventas ($)',
                    data: ventasHorarios,
                    backgroundColor: 'rgba(237, 137, 54, 0.1)',
                    borderColor: 'rgba(237, 137, 54, 1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    pointBackgroundColor: '#ed8936',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2,
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: true,
                  aspectRatio: isSmallMobile ? 1 : (isMobile ? 1.3 : 2.5),
                  plugins: {
                    legend: {
                      display: true,
                      position: 'top',
                      labels: {
                        font: {
                          size: isSmallMobile ? 11 : (isMobile ? 12 : 14)
                        },
                        padding: isMobile ? 10 : 15
                      }
                    },
                    tooltip: {
                      callbacks: {
                        label: function(context) {
                          const index = context.dataIndex;
                          const horario = data.ventasPorHora[index];
                          return [
                            'Ventas: $' + context.parsed.y.toFixed(2),
                            'Transacciones: ' + horario.ventas,
                            'Entradas: ' + horario.entradas
                          ];
                        }
                      },
                      titleFont: {
                        size: isSmallMobile ? 11 : 13
                      },
                      bodyFont: {
                        size: isSmallMobile ? 10 : 12
                      }
                    }
                  },
                  scales: {
                    x: {
                      ticks: {
                        font: {
                          size: isSmallMobile ? 8 : (isMobile ? 9 : 11)
                        },
                        maxRotation: isMobile ? 45 : 0,
                        minRotation: isMobile ? 45 : 0,
                        autoSkip: true,
                        maxTicksLimit: isSmallMobile ? 8 : (isMobile ? 12 : 24)
                      }
                    },
                    y: {
                      beginAtZero: true,
                      ticks: {
                        font: {
                          size: isSmallMobile ? 10 : (isMobile ? 11 : 12)
                        },
                        callback: function(value) {
                          return '$' + value.toFixed(0);
                        }
                      }
                    }
                  }
                }
              });
            }

            // Crear tarjetas de distribuci√≥n por periodo
            const periodosContainerEl = document.getElementById('periodosContainer');
            if (periodosContainerEl) {
              periodosContainerEl.innerHTML = '';

              const periodos = [
                { nombre: 'Ma√±ana', icon: 'üåÖ', horario: '6:00 - 12:00', data: data.distribucionPorPeriodo.ma√±ana, clase: 'periodo-ma√±ana' },
                { nombre: 'Tarde', icon: '‚òÄÔ∏è', horario: '12:00 - 18:00', data: data.distribucionPorPeriodo.tarde, clase: 'periodo-tarde' },
              ];

              periodos.forEach(periodo => {
                const periodoCard = document.createElement('div');
                periodoCard.className = `periodo-card ${periodo.clase}`;
                periodoCard.innerHTML = `
                  <div class="periodo-header">
                    <div>
                      <div class="periodo-icon">${periodo.icon}</div>
                      <div class="periodo-nombre">${periodo.nombre}</div>
                      <div class="periodo-horario">${periodo.horario}</div>
                    </div>
                  </div>
                  <div class="periodo-stats">
                    <div class="periodo-stat">
                      <span class="periodo-stat-label">Ventas</span>
                      <span class="periodo-stat-value">${formatMoney(periodo.data.total)}</span>
                    </div>
                    <div class="periodo-stat">
                      <span class="periodo-stat-label">Transacciones</span>
                      <span class="periodo-stat-value">${periodo.data.ventas}</span>
                    </div>
                  </div>
                `;
                periodosContainerEl.appendChild(periodoCard);
              });
            }
          }
        } catch (error) {
          console.error('Error al cargar an√°lisis de horarios:', error);
        }
      }

      // Funci√≥n para cargar y mostrar m√©tricas mensuales
      async function cargarMetricas() {
        try {
          const response = await fetch('/api/metricas-mensuales');
          const result = await response.json();

          if (result.success && result.data) {
            const data = result.data;

            // Actualizar t√≠tulo
            const titulo = document.getElementById('metricasTitulo');
            if (titulo) {
              titulo.textContent = `Ventas Diarias - ${data.mes.charAt(0).toUpperCase() + data.mes.slice(1)} ${data.a√±o}`;
            }

            // Actualizar resumen mensual
            const totalEfectivo = typeof data.total_efectivo === 'string' ? parseFloat(data.total_efectivo) : (data.total_efectivo || 0);
            const totalTransferencia = typeof data.total_transferencia === 'string' ? parseFloat(data.total_transferencia) : (data.total_transferencia || 0);
            const totalTerminal1 = typeof data.total_terminal1 === 'string' ? parseFloat(data.total_terminal1) : (data.total_terminal1 || 0);
            const totalTerminal2 = typeof data.total_terminal2 === 'string' ? parseFloat(data.total_terminal2) : (data.total_terminal2 || 0);
            const totalMes = totalEfectivo + totalTransferencia + totalTerminal1 + totalTerminal2;

            const totalMensualEl = document.getElementById('totalMensual');
            const entradasMensualEl = document.getElementById('entradasMensual');
            const ventasMensualEl = document.getElementById('ventasMensual');

            if (totalMensualEl) totalMensualEl.textContent = formatMoney(totalMes);
            if (entradasMensualEl) entradasMensualEl.textContent = String(data.total_entradas || 0);
            if (ventasMensualEl) ventasMensualEl.textContent = String(data.total_ventas || 0);

            // Preparar datos para la gr√°fica
            const labels = data.ventasPorDia.map((d) => `D√≠a ${d.dia}`);
            const ventasData = data.ventasPorDia.map((d) => d.total);

            // Destruir gr√°ficas anteriores si existen
            if (chartInstance) {
              chartInstance.destroy();
            }
            if (chartSemanalInstance) {
              chartSemanalInstance.destroy();
            }
            if (chartHorariosInstance) {
              chartHorariosInstance.destroy();
            }

            // Crear nueva gr√°fica diaria
            const ctx = document.getElementById('chartVentasDiarias');
            if (ctx) {
              // Detectar si es m√≥vil
              const isMobile = window.innerWidth <= 768;
              const isSmallMobile = window.innerWidth <= 480;

              chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                  labels: labels,
                  datasets: [{
                    label: 'Ventas ($)',
                    data: ventasData,
                    backgroundColor: 'rgba(159, 122, 234, 0.7)',
                    borderColor: 'rgba(159, 122, 234, 1)',
                    borderWidth: 2,
                    borderRadius: isSmallMobile ? 4 : 6,
                  }]
                },
                options: {
                  responsive: true,
                  maintainAspectRatio: true,
                  aspectRatio: isSmallMobile ? 1 : (isMobile ? 1.3 : 2),
                  plugins: {
                    legend: {
                      display: true,
                      position: 'top',
                      labels: {
                        font: {
                          size: isSmallMobile ? 11 : (isMobile ? 12 : 14)
                        },
                        padding: isMobile ? 10 : 15
                      }
                    },
                    tooltip: {
                      callbacks: {
                        label: function(context) {
                          return 'Ventas: $' + context.parsed.y.toFixed(2);
                        }
                      },
                      titleFont: {
                        size: isSmallMobile ? 11 : 13
                      },
                      bodyFont: {
                        size: isSmallMobile ? 10 : 12
                      }
                    }
                  },
                  scales: {
                    x: {
                      ticks: {
                        font: {
                          size: isSmallMobile ? 9 : (isMobile ? 10 : 12)
                        },
                        maxRotation: isMobile ? 45 : 0,
                        minRotation: isMobile ? 45 : 0,
                        autoSkip: true,
                        maxTicksLimit: isSmallMobile ? 10 : (isMobile ? 15 : 31)
                      }
                    },
                    y: {
                      beginAtZero: true,
                      ticks: {
                        font: {
                          size: isSmallMobile ? 10 : (isMobile ? 11 : 12)
                        },
                        callback: function(value) {
                          return '$' + value.toFixed(0);
                        }
                      }
                    }
                  }
                }
              });
            }

            // Crear gr√°fica semanal
            if (data.ventasPorSemana && data.ventasPorSemana.length > 0) {
              const labelsSemanales = data.ventasPorSemana.map((s) => `Semana ${s.semana}`);
              const ventasSemanales = data.ventasPorSemana.map((s) => s.total);

              const ctxSemanal = document.getElementById('chartVentasSemanales');
              if (ctxSemanal) {
                const isMobile = window.innerWidth <= 768;
                const isSmallMobile = window.innerWidth <= 480;

                chartSemanalInstance = new Chart(ctxSemanal, {
                  type: 'bar',
                  data: {
                    labels: labelsSemanales,
                    datasets: [{
                      label: 'Ventas ($)',
                      data: ventasSemanales,
                      backgroundColor: 'rgba(72, 187, 120, 0.7)',
                      borderColor: 'rgba(72, 187, 120, 1)',
                      borderWidth: 2,
                      borderRadius: isSmallMobile ? 4 : 6,
                    }]
                  },
                  options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: isSmallMobile ? 1.2 : (isMobile ? 1.5 : 2.5),
                    plugins: {
                      legend: {
                        display: true,
                        position: 'top',
                        labels: {
                          font: {
                            size: isSmallMobile ? 11 : (isMobile ? 12 : 14)
                          },
                          padding: isMobile ? 10 : 15
                        }
                      },
                      tooltip: {
                        callbacks: {
                          label: function(context) {
                            const index = context.dataIndex;
                            const semana = data.ventasPorSemana[index];
                            return [
                              'Ventas: $' + context.parsed.y.toFixed(2),
                              'Transacciones: ' + semana.ventas,
                              'Entradas: ' + semana.entradas
                            ];
                          }
                        },
                        titleFont: {
                          size: isSmallMobile ? 11 : 13
                        },
                        bodyFont: {
                          size: isSmallMobile ? 10 : 12
                        }
                      }
                    },
                    scales: {
                      x: {
                        ticks: {
                          font: {
                            size: isSmallMobile ? 10 : (isMobile ? 11 : 12)
                          }
                        }
                      },
                      y: {
                        beginAtZero: true,
                        ticks: {
                          font: {
                            size: isSmallMobile ? 10 : (isMobile ? 11 : 12)
                          },
                          callback: function(value) {
                            return '$' + value.toFixed(0);
                          }
                        }
                      }
                    }
                  }
                });
              }

              // Crear tarjetas de resumen por semana
              const resumenSemanasEl = document.getElementById('resumenSemanas');
              if (resumenSemanasEl) {
                resumenSemanasEl.innerHTML = '';

                // Encontrar el m√°ximo de cada m√©trica para las barras de progreso
                const maxTotal = Math.max(...data.ventasPorSemana.map(s => s.total));
                const maxVentas = Math.max(...data.ventasPorSemana.map(s => s.ventas));
                const maxEntradas = Math.max(...data.ventasPorSemana.map(s => s.entradas));

                data.ventasPorSemana.forEach((semana, index) => {
                  const semanaCard = document.createElement('div');
                  semanaCard.className = `semana-card semana-${semana.semana}`;

                  // Calcular porcentajes para barras de progreso
                  const porcentajeTotal = maxTotal > 0 ? (semana.total / maxTotal * 100) : 0;
                  const porcentajeVentas = maxVentas > 0 ? (semana.ventas / maxVentas * 100) : 0;
                  const porcentajeEntradas = maxEntradas > 0 ? (semana.entradas / maxEntradas * 100) : 0;

                  semanaCard.innerHTML = `
                    <div class="semana-header">
                      <div class="semana-numero-badge">
                        <span class="semana-numero">S${semana.semana}</span>
                      </div>
                      <span class="semana-rango">üìÖ D√≠as ${semana.rango}</span>
                    </div>
                    <div class="semana-stats">
                      <div class="semana-stat">
                        <div class="semana-stat-header">
                          <span class="semana-stat-label">
                            <span class="semana-stat-icon">üí∞</span>
                            Total Vendido
                          </span>
                          <span class="semana-stat-value highlight">${formatMoney(semana.total)}</span>
                        </div>
                        <div class="semana-progress-bar">
                          <div class="semana-progress-fill" style="width: ${porcentajeTotal}%"></div>
                        </div>
                      </div>

                      <div class="semana-divider"></div>

                      <div class="semana-stat">
                        <div class="semana-stat-header">
                          <span class="semana-stat-label">
                            <span class="semana-stat-icon">üìä</span>
                            Transacciones
                          </span>
                          <span class="semana-stat-value">${semana.ventas}</span>
                        </div>
                        <div class="semana-progress-bar">
                          <div class="semana-progress-fill" style="width: ${porcentajeVentas}%"></div>
                        </div>
                      </div>

                      <div class="semana-divider"></div>

                      <div class="semana-stat">
                        <div class="semana-stat-header">
                          <span class="semana-stat-label">
                            <span class="semana-stat-icon">üé´</span>
                            Entradas
                          </span>
                          <span class="semana-stat-value">${semana.entradas}</span>
                        </div>
                        <div class="semana-progress-bar">
                          <div class="semana-progress-fill" style="width: ${porcentajeEntradas}%"></div>
                        </div>
                      </div>
                    </div>
                  `;
                  resumenSemanasEl.appendChild(semanaCard);
                });
              }
            }
          }

          // Cargar an√°lisis de horarios
          await cargarAnalisisHorarios();
        } catch (error) {
          console.error('Error al cargar m√©tricas:', error);
        }
      }

      if (btnDiario) {
        btnDiario.addEventListener('click', function() {
          document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          mostrarReportes();
          cargarDatos('diario');
        });
      }

      if (btnSemanal) {
        btnSemanal.addEventListener('click', function() {
          document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          mostrarReportes();
          cargarDatos('semanal');
        });
      }

      if (btnMetricas) {
        btnMetricas.addEventListener('click', function() {
          document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
          this.classList.add('active');
          mostrarMetricas();
          cargarMetricas();
        });
      }

      // Listener para cambios de orientaci√≥n y redimensionamiento
      let resizeTimer;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(function() {
          // Si estamos en la vista de m√©tricas y hay gr√°ficas activas, recargarlas
          const metricasVisible = metricasContainer && metricasContainer.style.display !== 'none';
          if (metricasVisible && (chartInstance || chartSemanalInstance || chartHorariosInstance)) {
            cargarMetricas();
          }
        }, 250);
      });
    </script>
  </body>
</html>
